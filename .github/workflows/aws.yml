name: ECR + ECS CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  AWS_REGION: ap-northeast-2
  ECR_REGISTRY: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.ap-northeast-2.amazonaws.com
  ECS_CLUSTER_STAGING: eatcloud-cluster
  ECS_CLUSTER_PRODUCTION: eatcloud-cluster

jobs:
  # ë³€ê²½ëœ ì„œë¹„ìŠ¤ ê°ì§€
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      services: ${{ steps.changes.outputs.services }}
      matrix: ${{ steps.changes.outputs.matrix }}
      has_changes: ${{ steps.changes.outputs.has_changes }}
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Detect changed services
      id: changes
      run: |
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          # PRì˜ ê²½ìš° base ë¸Œëœì¹˜ì™€ ë¹„êµ
          changed_files=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
        else
          # Pushì˜ ê²½ìš° ì´ì „ ì»¤ë°‹ê³¼ ë¹„êµ
          changed_files=$(git diff --name-only HEAD~1 HEAD)
        fi
        
        echo "Changed files:"
        echo "$changed_files"
        
        services=()
        
        # ê° ì„œë¹„ìŠ¤ë³„ë¡œ ë³€ê²½ì‚¬í•­ í™•ì¸ (eureka-server, api-gateway ì œì™¸)
        for service in auth-service customer-service admin-service manager-service store-service order-service payment-service; do
          if echo "$changed_files" | grep -q "^$service/"; then
            services+=("$service")
          fi
        done
        
        # ë£¨íŠ¸ ë ˆë²¨ ë³€ê²½ì‚¬í•­ (ëª¨ë“  ì„œë¹„ìŠ¤ì— ì˜í–¥)
        if echo "$changed_files" | grep -qE "^(build\.gradle|settings\.gradle|docker-compose\.yml|gradle/|\.github/workflows/)"; then
          services=(auth-service customer-service admin-service manager-service store-service order-service payment-service)
        fi
        
        # ìµœì´ˆ ì»¤ë°‹ì´ë‚˜ ì„œë¹„ìŠ¤ê°€ ì—†ëŠ” ê²½ìš° ëª¨ë“  ì„œë¹„ìŠ¤ ë¹Œë“œ
        if [ ${#services[@]} -eq 0 ]; then
          services=(auth-service customer-service admin-service manager-service store-service order-service payment-service)
        fi
        
        # JSON ë°°ì—´ë¡œ ë³€í™˜
        services_json=$(printf '%s\n' "${services[@]}" | jq -R -s -c 'split("\n")[:-1]')
        echo "services=$services_json" >> $GITHUB_OUTPUT
        
        # Matrix ì „ëµì„ ìœ„í•œ í˜•íƒœë¡œ ë³€í™˜
        matrix_json=$(printf '%s\n' "${services[@]}" | jq -R -s -c '{"service": split("\n")[:-1]}')
        echo "matrix=$matrix_json" >> $GITHUB_OUTPUT
        
        # ë³€ê²½ì‚¬í•­ ì—¬ë¶€
        if [ ${#services[@]} -gt 0 ]; then
          echo "has_changes=true" >> $GITHUB_OUTPUT
        else
          echo "has_changes=false" >> $GITHUB_OUTPUT
        fi
        
        echo "Detected services: $services_json"

  # í…ŒìŠ¤íŠ¸ ë° ë¹Œë“œ
  test-and-build:
    needs: detect-changes
    if: needs.detect-changes.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{fromJson(needs.detect-changes.outputs.matrix)}}
      fail-fast: false
    
    steps:
    - uses: actions/checkout@v4

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: Cache Gradle packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: Test ${{ matrix.service }}
      run: ./gradlew :${{ matrix.service }}:test
      continue-on-error: true

    - name: Build ${{ matrix.service }}
      run: ./gradlew :${{ matrix.service }}:bootJar

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-${{ matrix.service }}-${{ github.sha }}
        path: ${{ matrix.service }}/build/reports/tests/
        retention-days: 7

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: jar-${{ matrix.service }}-${{ github.sha }}
        path: ${{ matrix.service }}/build/libs/*.jar
        retention-days: 30

  # ECRì— Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
  build-and-push-ecr:
    needs: [detect-changes, test-and-build]
    if: needs.detect-changes.outputs.has_changes == 'true' && github.event_name == 'push'
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{fromJson(needs.detect-changes.outputs.matrix)}}
      fail-fast: false

    steps:
    - uses: actions/checkout@v4

    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: jar-${{ matrix.service }}-${{ github.sha }}
        path: ${{ matrix.service }}/build/libs/

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2

    - name: Create ECR repository if not exists
      run: |
        aws ecr describe-repositories --repository-names eatcloud/${{ matrix.service }} || \
        aws ecr create-repository \
          --repository-name eatcloud/${{ matrix.service }} \
          --image-scanning-configuration scanOnPush=true \
          --encryption-configuration encryptionType=AES256

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    # ì§§ì€ SHA ê°’ì„ ë³„ë„ ìŠ¤í…ì—ì„œ ìƒì„±
    - name: Generate short SHA
      id: short-sha
      run: echo "sha_short=$(echo ${{ github.sha }} | cut -c1-8)" >> $GITHUB_OUTPUT

    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ${{ matrix.service }}/Dockerfile
        push: true
        tags: |
          ${{ env.ECR_REGISTRY }}/eatcloud/${{ matrix.service }}:latest
          ${{ env.ECR_REGISTRY }}/eatcloud/${{ matrix.service }}:${{ github.sha }}
          ${{ env.ECR_REGISTRY }}/eatcloud/${{ matrix.service }}:${{ steps.short-sha.outputs.sha_short }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        platforms: linux/arm64

    - name: Scan image for vulnerabilities
      run: |
        aws ecr start-image-scan --repository-name eatcloud/${{ matrix.service }} --image-id imageTag=latest || true

  # Staging ìë™ ë°°í¬ (develop ë¸Œëœì¹˜)
  deploy-staging:
    needs: [detect-changes, build-and-push-ecr]
    if: needs.detect-changes.outputs.has_changes == 'true' && github.ref == 'refs/heads/develop'
    runs-on: ubuntu-latest
    environment: staging
    strategy:
      matrix: ${{fromJson(needs.detect-changes.outputs.matrix)}}
      fail-fast: false
    
    steps:
    - uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Deploy to ECS Staging
      run: |
        # í˜„ì¬ íƒœìŠ¤í¬ ì •ì˜ ê°€ì ¸ì˜¤ê¸°
        TASK_DEFINITION=$(aws ecs describe-task-definition \
          --task-definition ${{ matrix.service }} \
          --query 'taskDefinition')
        
        # ìƒˆ ì´ë¯¸ì§€ URIë¡œ ì—…ë°ì´íŠ¸
        NEW_TASK_DEFINITION=$(echo $TASK_DEFINITION | jq --arg IMAGE "${{ env.ECR_REGISTRY }}/eatcloud/${{ matrix.service }}:${{ github.sha }}" \
          '.containerDefinitions[0].image = $IMAGE | del(.taskDefinitionArn) | del(.revision) | del(.status) | del(.requiresAttributes) | del(.placementConstraints) | del(.compatibilities) | del(.registeredAt) | del(.registeredBy)')
        
        # ìƒˆ íƒœìŠ¤í¬ ì •ì˜ ë“±ë¡
        NEW_REVISION=$(aws ecs register-task-definition \
          --cli-input-json "$NEW_TASK_DEFINITION" \
          --query 'taskDefinition.revision')
        
        # ì„œë¹„ìŠ¤ ì—…ë°ì´íŠ¸ (ìƒˆ íƒœìŠ¤í¬ ì •ì˜ ì‚¬ìš©)
        aws ecs update-service \
          --cluster ${{ env.ECS_CLUSTER_STAGING }} \
          --service ${{ matrix.service }} \
          --task-definition ${{ matrix.service }}:$NEW_REVISION \
          --force-new-deployment \
          --query 'service.{ServiceName:serviceName,Status:status,TaskDefinition:taskDefinition}'

    - name: Wait for deployment to complete
      run: |
        aws ecs wait services-stable \
          --cluster ${{ env.ECS_CLUSTER_STAGING }} \
          --services ${{ matrix.service }}
        
        echo "âœ… ${{ matrix.service }} staging deployment completed"

  # Production ìˆ˜ë™ ë°°í¬ ì¤€ë¹„ ì•Œë¦¼
  production-deploy-ready:
    needs: [detect-changes, build-and-push-ecr]
    if: needs.detect-changes.outputs.has_changes == 'true' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    
    steps:
    - name: Production deployment notification
      run: |
        echo "ğŸš€ Production deployment ready!"
        echo "Services: ${{ needs.detect-changes.outputs.services }}"
        echo "Image SHA: ${{ github.sha }}"
        echo "ECR Images:"
        echo "${{ needs.detect-changes.outputs.services }}" | jq -r '.[]' | while read service; do
          echo "  - ${{ env.ECR_REGISTRY }}/eatcloud/${service}:${{ github.sha }}"
        done
        echo ""
        echo "To deploy to production:"
        echo "1. Go to Actions tab"
        echo "2. Run 'Deploy to Production (ECR + ECS)' workflow"
        echo "3. Select services and image tag: ${{ github.sha }}"
